<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yayiabc.http.mvc.dao.UserDao">


	<insert id="register" parameterType="User">
		insert into user(user_id,phone,pwd,created,updated)
		values(#{userId},#{phone},#{pwd},now(),now())
	</insert>
	<select id="getUserByUser" resultMap="userMap">
		SELECT
		c.*,d.type,d.company_name,d.part,d.doctor_pic,d.work_address,d.business_license
		FROM
		(SELECT a.*,b.phone sale_phone,b.true_name sale_name FROM
		(SELECT * FROM user WHERE phone=#{phone}) a
		LEFT JOIN
		sale_info b
		ON a.sale_id=b.sale_id)c
		LEFT JOIN
		certification d
		ON d.user_id=c.user_id
	</select>
	<resultMap type="User" id="userMap" autoMapping="true">
		<id column="user_id" property="userId" jdbcType="VARCHAR" />
		<association property="certification" javaType="Certification"
			autoMapping="true">
			<id property="certificationId" column="certification_id" />
		</association>
		<association property="saleinfo" javaType="SaleInfo"
			autoMapping="true">
			<id property="saleId" column="sale_id" />
			<result property="phone" column="sale_phone" />
			<result property="trueName" column="sale_name" />
		</association>
	</resultMap>
	<select id="getCartNum" resultType="int">
		select count(*) from cart where user_id=#{userId}
	</select>
	<update id="updatePwd">
		update user set pwd=#{pwd} where phone=#{phone}
	</update>

	<select id="getUserId" resultType="String">
		select user_id from user where phone=#{phone};
	</select>


	<select id="getTokenByUserId" resultType="string">
		select token from user_token where user_id=#{userId}
	</select>

	<insert id="addToken">
		insert into user_token values (#{token},#{userId})
	</insert>

	<update id="updateToken">
		UPDATE user_token SET token = #{token} WHERE user_id = #{userId}
	</update>

	<delete id="deleteToken">
		DELETE FROM user_token WHERE token = #{_parameter}
	</delete>

	<select id="getUserIdByToken" resultType="string">
		select user_id from user_token where token=#{token}
	</select>


    
    
    <select id="getSaleCount" resultType="java.lang.Integer">
    	select count(0) from sale_info where phone=#{phone}
    </select>

	<update id="bindSale">
		UPDATE user SET sale_id = #{1},bind_sale_time=now() WHERE user_id = #{0}
	</update>

	
	
	<update id="updateUserInfo" parameterType="User">
		update user set true_name=#{trueName},sex=#{sex} where phone=#{phone}
	</update>
	
	<update id="updateCertification">
		update certification set type=#{certification.type},company_name=#{certification.companyName},part=#{certification.part},
		work_address=#{certification.workAddress} where user_id=#{userId}
	</update>
	
	<select id="getUserIdByPhone" resultType="string">
		select user_id from user where phone=#{phone}
	</select>
	
	<update id="registerUserInfo">
		update user set true_name=#{trueName},sex=#{sex} where user_id=#{userId}
	</update>
	
	<insert id="registerUserCertification">
		insert into certification(user_id,type,company_name,part,work_address) values(#{userId},#{certification.type},#{certification.companyName},#{certification.part},#{certification.workAddress})
	</insert>

</mapper>       