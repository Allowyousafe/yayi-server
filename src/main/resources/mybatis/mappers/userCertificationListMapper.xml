<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yayiabc.http.mvc.dao.UserCertificationListDao">
	<resultMap type="User" id="userCertificationListRM">
		<id column="user_id" property="userId"/>
		<result column="phone" property="phone"/>
		<result column="true_name" property="trueName"/>
		<association property="certification" 
			javaType="com.yayiabc.http.mvc.pojo.jpa.Certification">
			<id column="user_id" property="userId"/>
			<result column="type" property="type"/>
			<result column="company_name" property="companyName"/>
			<result column="part" property="part"/>
			<result column="work_address" property="workAddress"/>
			<result column="doctor_pic" property="doctorPic"/>
			<result column="state" property="state"/>
			<result column="fail_reason" property="failReason"/>
		</association>
	</resultMap>
	
	<select id="list" resultMap="userCertificationListRM">
		SELECT c.user_id,u.phone,u.true_name,c.type,c.company_name,c.part,c.work_address,c.doctor_pic,c.state,c.fail_reason 
		FROM certification c
		LEFT JOIN user u
		ON c.user_id=u.user_id	
		<where>
			<if test="phone !=null and phone !=''">
				u.phone LIKE '%${phone}%'
			</if>
			<if test="trueName !=null and trueName !=''">
				AND u.true_name LIKE '%${trueName}%'
			</if>
			<if test="companyName !=null and companyName !=''">
				AND c.company_name  LIKE '%${companyName}%'
			</if>
			<if test="type !=null and type !=''">
				AND c.type=#{type}
			</if>
			<if test="state !=null and state !=''">
				AND c.state=#{state}
			</if>
		</where>
		GROUP BY c.user_id	
		ORDER BY c.created DESC
        LIMIT ${page.currentNumber},${page.numberPerPage}
	</select>
	
	<select id="getCount" resultType="int">
		SELECT count(0)
		FROM certification c
		LEFT JOIN user u
		ON c.user_id=u.user_id	
		<where>
			<if test="phone !=null and phone !=''">
				u.phone LIKE '%${phone}%'
			</if>
			<if test="trueName !=null and trueName !=''">
				AND u.true_name LIKE '%${trueName}%'
			</if>
			<if test="companyName !=null and companyName !=''">
				AND c.company_name  LIKE '%${companyName}%'
			</if>
			<if test="type !=null and type !=''">
				AND c.type=#{type}
			</if>
			<if test="state !=null and state !=''">
				AND c.state=#{state}
			</if>
		</where>
	</select>
	
	<update id="verify">
		UPDATE certification 
		<set>
			<if test="state !=null and state !=''">
				state=#{state},
			</if>
				fail_reason=#{failReason}
		</set>
		WHERE user_id=#{userId}
	</update>
</mapper>        