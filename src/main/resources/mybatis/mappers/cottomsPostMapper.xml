<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yayiabc.http.mvc.dao.CottomsPostDao">
	<select id="gettrueName" resultType="java.lang.String">
		select true_name,phone from user where user_id=#{userId}
	</select>
	<insert id="addPost">
		insert into cottoms_post
		(headline,classify,charge_type,free_content,charge_content,writer,userId,read_number,post_favour,charge_number,post_stater)
		values(#{headline},#{classify},#{chargeType},#{freeContent},#{chargeContent},#{writer},#{userId},0,0,#{chargeNumber},#{postStater})
	</insert>

	<select id="queryPost" resultType="java.util.Map">
		select * from cottoms_post
		<where>
			<if test="classify!=null and classify!=''">
				classify=#{classify} and
			</if>
				post_Stater=1
		</where>
		order by 
		<choose>
			<when test="order=0">post_time</when>
			<when test="order=1">post_favour desc</when>
			<when test="order=2">read_number desc</when>
		</choose>
		limit #{page.currentNumber},#{page.numberPerPage}
	</select>
	
	<select id="queryDraft" resultType="java.util.Map">
		select * from cottoms_post
		<where>
			<if test="classify!=null and classify!=''">
				classify=#{classify} and
			</if>
				post_Stater=2
		</where>
		order by 
		<choose>
			<when test="order=0">post_time</when>
			<when test="order=1">post_favour desc</when>
			<when test="order=2">read_number desc</when>
		</choose>
		limit #{page.currentNumber},#{page.numberPerPage}
	</select>
	
	<select id="getTotalNumber" resultType="int">
		select count(0) from
		cottoms_post
	</select>
	<select id="getTotalCommentNumber" resultType="int">
		select count(0)
		from cottoms_post
	</select>

	<resultMap type="CottomsPost" id="cottomsDetail" autoMapping="true">
		<id property="postId" column="post_id" />
		<collection property="commentsList" select="cottomsCommentDetail"
			column="post_id" ofType="CottomsComment" />
	</resultMap>
	<resultMap type="CottomsComment" id="cottomsCommentDetail"
		autoMapping="true">
		<id property="commentId" column="comment_id" />
		<collection property="cottomsReplyList" select="cottomsReplyDetail"
			column="comment_id" ofType="CottomsReply" />
	</resultMap>
	<select id="cottomsDetail" resultMap="cottomsDetail">
		select * from cottoms_post
		where post_id=#{postId} order by post_time
	</select>
	<select id="cottomsCommentDetail" parameterType="java.lang.Integer"
		resultMap="cottomsCommentDetail">
		select * from cottoms_comment where post_id=#{post_id} order
		by comment_time
	</select>
	<select id="cottomsReplyDetail" resultType="CottomsReply"
		parameterType="java.lang.Integer">
		select * from cottoms_reply where
		comment_id=#{comment_id} order by reply_time
	</select>

	<insert id="comment">
		insert into cottoms_comment
		(comment,by_critic,comment_content,post_id,commentFavour) values
		(#{comment},#{byCritic},#{commentContent},#{postId},0)
	</insert>

	<insert id="reply">
		insert into cottoms_reply
		(replyer,by_reply,reply_content,comment_id,reply_favour) values
		(#{replyer},#{byReply},#{replyContent},#{commentId},0)
	</insert>

	<select id="postLike" resultType="java.lang.Integer">
		select post_favour from
		cottoms_post where post_id=#{postId}
	</select>
	<update id="postLikeAdd">
		update cottoms_post
		set post_favour=#{postFavour}
		where post_id=#{postId}
	</update>

	<select id="commentsLike" resultType="java.lang.Integer">
		select comment_favour from
		cottoms_comment where comment_id=#{commentId}
	</select>
	<update id="commentsLikeAdd">
		update cottoms_comment
		set
		comment_favour=#{commentFavour}
		where comment_id=#{commentId}
	</update>
	<select id="postReaderNumber" resultType="java.lang.Integer">
		select read_number from
		cottoms_post where post_id=#{postId}
	</select>
	<select id="commentNumber" resultType="java.lang.Integer">
		select count(0) from
		cottoms_comment where post_id=#{postId}
	</select>
	<update id="postReader">
		update cottoms_post
		set read_number=#{readNumber}
		where post_id=#{postId}
	</update>

	<select id="see" resultType="com.yayiabc.http.mvc.pojo.jpa.See">
		SELECT
		true_name,phone,qb_rget,qb_rout,qb_time,remark
		FROM qb_record LEFT JOIN
		USER ON qb_record.user_id=user.user_id
		AND qb_time between '2017-10-25'
		AND '2017-10-29'
		AND remark LIKE '%充值%'
	</select>
</mapper>