<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yayiabc.http.mvc.dao.CommentDao">
	<insert id="addComment">
		insert into top_comment(user_id,content,becommented_id,`type`)
		VALUES (#{userId},#{coment.commentContent},#{beCommentedId},#{num})
	</insert>

	<insert id="addSubComment">
		insert into lower_comment(user_id,content,top_id)
		VALUES (#{userId},#{comment.commentContent},#{parentId})
	</insert>

	<select id="getUserByPostId" resultType="User">
		SELECT b.user_id,b.true_name
		FROM cottoms_post a
		LEFT JOIN `user` b ON a.user_id=b.user_id
		WHERE a.id=#{beCommentedId}
	</select>

	<select id="getUserByTopCommentId" resultType="User">
		SELECT b.user_id,b.true_name
		FROM top_comment a
		LEFT JOIN `user` b ON a.user_id=b.user_id
		WHERE a.id=#{beCommentedId}
	</select>

	<select id="getCommentTotalNum" resultType="int">
		select count(*) from top_comment where type=#{numberType} and becommented_id=#{beCommentedId}
	</select>



	<select id="getCommentList" resultType="Comment">
		SELECT * FROM
		(SELECT a.id,a.content,a.created,a.reply_num,b.user_id,b.true_name,b.user_pic
		FROM top_comment a
		LEFT JOIN `user` b ON a.user_id=b.user_id
		WHERE a.becommented_id=#{beCommentedId} AND a.type=#{numberType} order by a.created DESC ) c
		LEFT JOIN
		(
		SELECT d.id AS sub_id,d.content AS sub_content,d.created AS sub_created,e.user_id AS sub_user_id,e.true_name AS sub_user_name,e.user_pic AS sub_user_pic,d.top_id
		FROM lower_comment d
		LEFT JOIN `user` e ON d.user_id=e.user_id
		) f ON c.id=f.top_id
		limit #{page.currentNumber},#{page.numberPerPage}
	</select>

	<delete id="deleteYayiCom">
		delete from dentist_comment where moment_id=#{parentId}
	</delete>

	<delete id="deleteSubComment">
		delete from lower_comment where id=#{presentId}
	</delete>

	<delete id="deleteComment">
		delete from top_comment where id=#{parentId}
	</delete>

	<delete id="deleteWithSubComment">
		delete from lower_comment where top_id=#{parentId}
	</delete>

	<select id="getCommentNum" resultType="int">
		select count(*) FROM top_comment where becommented_id=#{becommentedId} and type=#{type}
	</select>

	<update id="updateCommentReplyNum">
		update top_comment set reply_num=reply_num+1 where id=#{parentId}
	</update>

	<update id="addCommentNumberToVideo">
		update vid_manage set comment_num=comment_num+1 where vi_id=#{beCommentedId}
	</update>


</mapper>       