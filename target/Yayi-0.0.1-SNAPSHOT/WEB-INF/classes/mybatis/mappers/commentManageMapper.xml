<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
        
<mapper namespace="com.yayiabc.http.mvc.dao.CommentManageDao">
	<!-- 订单表 -->
	<resultMap type="com.yayiabc.http.mvc.pojo.jpa.Ordera" id="CommentManagementResultMap">
		<id column="order_id" property="orderId" />
		<!-- 订单商品表 -->
		<collection property="orderitemList" ofType="OrderItem">
			<id property="itemId" column="item_id" />
			<result property="itemPropertyNamea" column="item_property_namea" />
			<result property="itemPropertyNameb" column="item_property_nameb" />
			<result property="itemPropertyNamec" column="item_property_namec" />
			<!-- 评论表 -->
			<collection property="commentList" ofType="com.yayiabc.http.mvc.pojo.jpa.Comments">
				<id property="commentId" column="comment_id" />
				<result property="userId" column="user_id" />
				<result property="orderId" column="order_id" />
				<result property="recoveryState" column="recovery_state" />
				<result property="replyContent" column="reply_content" />
				<result property="commentGrade" column="comment_grade" />
				<result property="commentContent" column="comment_content" />
				<!-- 商品表 -->
				<association property="itemInfo" javaType="ItemInfo">
			       <id property="itemId" column="item_id" />
			       <result property="itemName" column="item_name" />
		        </association>
			</collection>
		</collection>

	</resultMap>


	<select id="commentM" resultMap="CommentManagementResultMap">
		SELECT
		iif.item_name,oim.item_property_namea,oim.item_property_nameb,oim.item_property_namec
		,
		comm.comment_content,comm.comment_grade,comm.order_id,comm.user_id,comm.recovery_state,comm.reply_content
		FROM
		ordera orde,order_item oim ,COMMENTS comm,item_info iif,item_detail idl
		 <where>
		 
		 orde.order_id=oim.order_id AND oim.item_id=comm.item_id AND comm.item_id=iif.item_id
		  AND iif.item_id=idl.item_id 
		 
		   <if test="orderId!=null">
		     and orde.order_id=#{orderId} 
		  </if>
		<!--  <if test="userId!=null">
		     and orde.user_id=#{userId} 
		 </if><else>
		   and orde.user_id=#{phone}
		  </else> -->
		  <if test="recoveryState!=null">
		     and comm.recovery_state=#{recoveryState} 
		 </if>
		<choose>
        <when test="userId!=null">
            and orde.user_id=#{userId} 
        </when>
        <otherwise>
            and orde.user_id=#{phone}
        </otherwise>
       </choose>

		 </where>
		
	</select>
	<!-- 回复 -->
	<insert id="reply">
	  insert into comments(reply_content,recovery_state) values(#{data},1) where item_id=#{itemId} and orderId=#{orderId}
	</insert>
	
</mapper>